<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>OCR Table to Google Sheets</title>
<style>
    body { font-family: Arial, sans-serif; padding: 10px; }
    #preview { max-width: 100%; margin-top: 10px; }
    pre { background: #f0f0f0; padding: 5px; font-size: 12px; }
</style>
</head>
<body>

<h2>OCR Table Parser (Browser + Google Sheets)</h2>
<input type="file" id="fileInput" accept="image/*"><br><br>
<img id="preview" />

<h3>Step 1: Process → Parse → Review</h3>
<button id="runOCR">Run OCR & Parse</button>
<button id="sendToSheets" disabled>Send All Rows to Google Sheet</button>

<h4>Detected Rows</h4>
<div id="rowsContainer"></div>

<h4>Debug Log</h4>
<pre id="log"></pre>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script async src="https://docs.opencv.org/4.x/opencv.js"></script>
<script>
let imageMat, rowsData = [];
let logEl = document.getElementById('log');
let previewEl = document.getElementById('preview');

function log(msg) {
    console.log(msg);
    logEl.textContent += msg + "\n";
}

document.getElementById('fileInput').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const url = URL.createObjectURL(file);
    previewEl.src = url;
    previewEl.onload = () => {
        log("Image loaded: " + file.name);
    };
});

document.getElementById('runOCR').addEventListener('click', async () => {
    if (!previewEl.src) return alert("Please select an image first.");
    log("Starting OCR process...");
    
    await cv['onRuntimeInitialized']; // Wait for OpenCV

    // Load image into OpenCV
    let src = cv.imread(previewEl);
    let gray = new cv.Mat();
    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
    
    // Threshold to get binary image
    let thresh = new cv.Mat();
    cv.adaptiveThreshold(gray, thresh, 255, cv.ADAPTIVE_THRESH_MEAN_C, cv.THRESH_BINARY_INV, 15, 15);

    // Detect horizontal lines
    let horizontal = thresh.clone();
    let horizontalsize = Math.floor(horizontal.cols / 30);
    let horizontalStructure = cv.getStructuringElement(cv.MORPH_RECT, new cv.Size(horizontalsize, 1));
    cv.erode(horizontal, horizontal, horizontalStructure);
    cv.dilate(horizontal, horizontal, horizontalStructure);

    // Detect vertical lines
    let vertical = thresh.clone();
    let verticalsize = Math.floor(vertical.rows / 30);
    let verticalStructure = cv.getStructuringElement(cv.MORPH_RECT, new cv.Size(1, verticalsize));
    cv.erode(vertical, vertical, verticalStructure);
    cv.dilate(vertical, vertical, verticalStructure);

    // Combine lines to get table grid
    let mask = new cv.Mat();
    cv.add(horizontal, vertical, mask);

    // Find contours (cells)
    let contours = new cv.MatVector();
    let hierarchy = new cv.Mat();
    cv.findContours(mask, contours, hierarchy, cv.RETR_TREE, cv.CHAIN_APPROX_SIMPLE);

    log(`Detected ${contours.size()} cell contours`);

    let cells = [];
    for (let i = 0; i < contours.size(); i++) {
        let rect = cv.boundingRect(contours.get(i));
        if (rect.width > 30 && rect.height > 15) { // skip noise
            cells.push(rect);
        }
    }

    // Sort cells by row/col
    cells.sort((a, b) => {
        if (Math.abs(a.y - b.y) > 15) return a.y - b.y;
        return a.x - b.x;
    });

    // Run Tesseract per cell
    rowsData = [];
    let currentRow = [], lastY = null;
    for (let rect of cells) {
        let roi = src.roi(rect);
        let canvas = document.createElement('canvas');
        cv.imshow(canvas, roi);
        let dataUrl = canvas.toDataURL();

        let text = await Tesseract.recognize(dataUrl, 'eng', { logger: m => {} });
        let cleaned = text.data.text.trim();
        
        if (lastY !== null && Math.abs(rect.y - lastY) > rect.height) {
            rowsData.push(currentRow);
            currentRow = [];
        }
        currentRow.push(cleaned);
        lastY = rect.y;
        roi.delete();
    }
    if (currentRow.length) rowsData.push(currentRow);

    log(`Parsed ${rowsData.length} rows`);

    // Show rows
    let rowsHtml = rowsData.map(r => `<div>${r.join(' | ')}</div>`).join('');
    document.getElementById('rowsContainer').innerHTML = rowsHtml;

    src.delete(); gray.delete(); thresh.delete();
    horizontal.delete(); vertical.delete(); mask.delete();
    contours.delete(); hierarchy.delete();
    document.getElementById('sendToSheets').disabled = false;
});

document.getElementById('sendToSheets').addEventListener('click', async () => {
    const scriptUrl = "YOUR_GOOGLE_APPS_SCRIPT_WEBAPP_URL"; // change to your URL
    log("Sending data to Google Sheets...");
    try {
        let res = await fetch(scriptUrl, {
            method: "POST",
            body: JSON.stringify({ rows: rowsData }),
            headers: { "Content-Type": "application/json" }
        });
        log("Google Sheets response: " + await res.text());
    } catch (err) {
        log("Error: " + err);
    }
});
</script>
</body>
</html>
