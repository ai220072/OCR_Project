<!DOCTYPE html>
<html>
<head>
  <title>Table OCR to Google Sheets</title>
  <meta charset="UTF-8">
  <style>
    body { font-family: Arial, sans-serif; padding: 10px; }
    canvas { border: 1px solid #ccc; cursor: crosshair; }
    #log { height: 150px; overflow-y: auto; background: #f4f4f4; padding: 5px; border: 1px solid #ddd; margin-top: 10px; }
    button { margin: 5px 0; }
  </style>
</head>
<body>
  <h2>OCR Table â†’ Google Sheets</h2>
  <input type="file" id="fileInput"><br><br>
  <canvas id="canvas"></canvas><br>
  <button id="runOCR">Run OCR</button>
  <button id="sendToSheets">Send to Google Sheets</button>
  <div id="log"></div>

  <script src="https://docs.opencv.org/4.x/opencv.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <script>
    const fileInput = document.getElementById('fileInput');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const logBox = document.getElementById('log');

    let img = new Image();
    let colLines = []; // x positions of column lines
    let draggingLine = null;
    let ocrResults = [];

    function log(msg) {
      logBox.innerHTML += msg + "<br>";
      logBox.scrollTop = logBox.scrollHeight;
    }

    // Load image
    fileInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        img.onload = () => {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          detectColumns();
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });

    // Basic column detection using OpenCV
    function detectColumns() {
      let src = cv.imread(img);
      let gray = new cv.Mat();
      cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
      cv.threshold(gray, gray, 0, 255, cv.THRESH_BINARY_INV + cv.THRESH_OTSU);

      let verticalKernel = cv.getStructuringElement(cv.MORPH_RECT, new cv.Size(1, 75));
      let temp = new cv.Mat();
      cv.erode(gray, temp, verticalKernel);
      cv.dilate(temp, temp, verticalKernel);

      // Find contours (vertical lines)
      let contours = new cv.MatVector();
      let hierarchy = new cv.Mat();
      cv.findContours(temp, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
      colLines = [];
      for (let i = 0; i < contours.size(); i++) {
        let rect = cv.boundingRect(contours.get(i));
        colLines.push(rect.x);
      }
      colLines.sort((a, b) => a - b);

      src.delete(); gray.delete(); temp.delete(); contours.delete(); hierarchy.delete();
      drawCanvas();
      log("Detected " + colLines.length + " column lines. Drag to adjust.");
    }

    // Draw image + vertical lines
    function drawCanvas() {
      ctx.drawImage(img, 0, 0);
      ctx.strokeStyle = "red";
      ctx.lineWidth = 2;
      colLines.forEach(x => {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
      });
    }

    // Drag-to-adjust
    canvas.addEventListener('mousedown', e => {
      const mx = e.offsetX;
      for (let i = 0; i < colLines.length; i++) {
        if (Math.abs(mx - colLines[i]) < 5) {
          draggingLine = i;
          break;
        }
      }
    });
    canvas.addEventListener('mousemove', e => {
      if (draggingLine !== null) {
        colLines[draggingLine] = e.offsetX;
        drawCanvas();
      }
    });
    canvas.addEventListener('mouseup', () => draggingLine = null);

    // Run OCR per column & row
    document.getElementById('runOCR').addEventListener('click', async () => {
      log("Running OCR...");
      ocrResults = [];
      // For now, we just run OCR on the full image, then you can split per row/col if needed
      let result = await Tesseract.recognize(img.src, 'eng', { logger: m => {} });
      log("OCR done.");
      log(result.data.text);
      ocrResults.push(result.data.text);
    });

    // Send to Google Sheets
    document.getElementById('sendToSheets').addEventListener('click', async () => {
      if (!ocrResults.length) {
        log("No OCR data to send!");
        return;
      }
      const url = "YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL"; // Replace with your script URL
      let data = { rows: ocrResults }; 
      let res = await fetch(url, {
        method: "POST",
        body: JSON.stringify(data),
        headers: { "Content-Type": "application/json" }
      });
      let text = await res.text();
      log("Sent to Sheets: " + text);
    });
  </script>
</body>
</html>
