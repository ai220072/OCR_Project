<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>OCR Table Extractor</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        canvas { max-width: 100%; border: 1px solid #ccc; margin-top: 10px; }
        table { border-collapse: collapse; margin-top: 20px; width: 100%; }
        table, th, td { border: 1px solid black; padding: 5px; }
    </style>
</head>
<body>
    <h2>OCR Table Extractor (Offline)</h2>
    <input type="file" id="imageInput" accept="image/*"><br>
    <canvas id="canvas"></canvas>
    <table id="outputTable">
        <thead>
            <tr>
                <th>Proposal No</th>
                <th>Company Name</th>
                <th>Person in Charge</th>
                <th>Tel/Fax</th>
                <th>State</th>
                <th>Company Address</th>
                <th>Type of Project</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- OpenCV.js -->
    <script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady();"></script>
    <!-- Tesseract.js -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

    <script>
        let imgElement = document.createElement('img');
        let canvas = document.getElementById('canvas');
        let ctx = canvas.getContext('2d');

        document.getElementById('imageInput').addEventListener('change', function(e) {
            let file = e.target.files[0];
            let reader = new FileReader();
            reader.onload = function(event) {
                imgElement.onload = function() {
                    canvas.width = imgElement.width;
                    canvas.height = imgElement.height;
                    ctx.drawImage(imgElement, 0, 0);
                    processImage();
                };
                imgElement.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        function onOpenCvReady() {
            console.log("‚úÖ OpenCV.js loaded");
        }

        function processImage() {
            let src = cv.imread(imgElement);
            let gray = new cv.Mat();
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);

            let thresh = new cv.Mat();
            cv.threshold(gray, thresh, 0, 255, cv.THRESH_BINARY + cv.THRESH_OTSU);

            let contours = new cv.MatVector();
            let hierarchy = new cv.Mat();
            cv.findContours(thresh, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

            console.log(`üîç Found ${contours.size()} contours`);

            let boundingBoxes = [];
            for (let i = 0; i < contours.size(); i++) {
                let rect = cv.boundingRect(contours.get(i));
                if (rect.width > 50 && rect.height > 20) { // filter noise
                    boundingBoxes.push(rect);
                }
            }

            boundingBoxes.sort((a, b) => a.y - b.y || a.x - b.x);

            console.log("üì¶ Bounding boxes:", boundingBoxes);

            let results = [];
            let ocrPromises = boundingBoxes.map((box, idx) => {
                let roi = src.roi(box);
                let roiCanvas = document.createElement('canvas');
                roiCanvas.width = box.width;
                roiCanvas.height = box.height;
                cv.imshow(roiCanvas, roi);

                return Tesseract.recognize(roiCanvas, 'eng', {
                    logger: info => console.log(`OCR ${idx}:`, info)
                }).then(({ data: { text } }) => {
                    console.log(`üìù Box ${idx} Text:`, text.trim());
                    results.push(text.trim());
                });
            });

            Promise.all(ocrPromises).then(() => {
                console.log("‚úÖ OCR Finished", results);
                addToTable(results);
            });

            src.delete(); gray.delete(); thresh.delete(); contours.delete(); hierarchy.delete();
        }

        function addToTable(data) {
            // NOTE: This is just a simple mapping ‚Äî adjust to match your actual table structure
            let tbody = document.querySelector("#outputTable tbody");
            tbody.innerHTML = "";
            let row = document.createElement("tr");
            for (let i = 0; i < 7; i++) {
                let td = document.createElement("td");
                td.textContent = data[i] || "";
                row.appendChild(td);
            }
            tbody.appendChild(row);
        }
    </script>
</body>
</html>
